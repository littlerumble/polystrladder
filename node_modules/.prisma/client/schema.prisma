generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Market metadata from Polymarket
model Market {
  id            String    @id
  question      String    @db.Text
  description   String?   @db.Text
  category      String
  subcategory   String?
  endDate       DateTime
  gameStartTime DateTime? // When the match/event actually starts
  volume24h     Float     @default(0)
  liquidity     Float     @default(0)
  outcomes      String    @db.Text // JSON array of outcomes
  clobTokenIds  String    @db.Text // JSON array of token IDs
  active        Boolean   @default(true)
  closed        Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  trades         Trade[]
  positions      Position[]
  strategyEvents StrategyEvent[]
  priceHistory   PriceHistory[]
  marketStates   MarketState[]
  marketTrades   MarketTrade[]
}

// Complete trade lifecycle tracking for P&L
model MarketTrade {
  id       Int    @id @default(autoincrement())
  marketId String
  market   Market @relation(fields: [marketId], references: [id])

  // Position info
  side   String // 'YES' or 'NO'
  status String @default("OPEN") // 'OPEN' or 'CLOSED'

  // Entry details
  entryPrice  Float // Weighted avg entry price
  entryShares Float // Total shares bought
  entryAmount Float // Total $ invested (cost basis)
  entryTime   DateTime // First entry timestamp

  // Exit details (null if still open)
  exitPrice  Float? // Weighted avg exit price
  exitShares Float? // Total shares sold
  exitAmount Float? // Total $ received on exit
  exitTime   DateTime? // Full exit timestamp
  exitReason String?   @db.Text // Why we exited (e.g. "STOP LOSS: Price 0.43 < 0.65")

  // P&L metrics
  profitLoss    Float @default(0) // $ profit or loss (realized)
  profitLossPct Float @default(0) // % return

  // Current state (for open positions)
  currentShares Float  @default(0) // Remaining shares
  currentPrice  Float? // Latest market price
  unrealizedPnl Float  @default(0) // Current unrealized P&L

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([marketId])
  @@index([status])
}

// Individual trades executed by the bot
model Trade {
  id             Int      @id @default(autoincrement())
  marketId       String
  market         Market   @relation(fields: [marketId], references: [id])
  side           String // YES or NO (Asset)
  action         String   @default("BUY") // BUY or SELL
  price          Float
  size           Float // USDC amount
  shares         Float // Number of shares
  strategy       String // LADDER_COMPRESSION, VOLATILITY_ABSORPTION, TAIL_INSURANCE
  strategyDetail String?  @db.Text // e.g., ladder level or exit reason
  status         String   @default("FILLED") // FILLED, PENDING, REJECTED
  timestamp      DateTime @default(now())
}

// Current positions held by the bot
model Position {
  id            Int      @id @default(autoincrement())
  marketId      String   @unique
  market        Market   @relation(fields: [marketId], references: [id])
  sharesYes     Float    @default(0)
  sharesNo      Float    @default(0)
  avgEntryYes   Float?
  avgEntryNo    Float?
  costBasisYes  Float    @default(0)
  costBasisNo   Float    @default(0)
  unrealizedPnl Float    @default(0)
  realizedPnl   Float    @default(0)
  updatedAt     DateTime @updatedAt
}

// Periodic P&L snapshots for charting
model PnlSnapshot {
  id             Int      @id @default(autoincrement())
  totalValue     Float // Total portfolio value
  cashBalance    Float // Remaining cash
  positionsValue Float // Value of all positions
  unrealizedPnl  Float
  realizedPnl    Float
  timestamp      DateTime @default(now())
}

// Strategy decision events for debugging/analysis
model StrategyEvent {
  id        Int      @id @default(autoincrement())
  marketId  String
  market    Market   @relation(fields: [marketId], references: [id])
  regime    String // EARLY_UNCERTAIN, MID_CONSENSUS, LATE_COMPRESSED, HIGH_VOLATILITY
  strategy  String // Strategy type selected
  action    String // ENTER, SKIP, LADDER_FILL, TAIL_TRIGGER, etc.
  priceYes  Float
  priceNo   Float
  details   String?  @db.Text // JSON with additional context
  timestamp DateTime @default(now())
}

// Price history for volatility calculation
model PriceHistory {
  id         Int      @id @default(autoincrement())
  marketId   String
  market     Market   @relation(fields: [marketId], references: [id])
  priceYes   Float
  priceNo    Float
  bestBidYes Float?
  bestAskYes Float?
  bestBidNo  Float?
  bestAskNo  Float?
  timestamp  DateTime @default(now())

  @@index([marketId, timestamp])
}

// Per-market state tracking (ladder levels filled, etc.)
model MarketState {
  id                  Int       @id @default(autoincrement())
  marketId            String    @unique
  market              Market    @relation(fields: [marketId], references: [id])
  regime              String    @default("MID_CONSENSUS")
  ladderFilled        String    @default("[]") // JSON array of filled ladder levels
  ladderLevelTouched  String    @default("{}") @db.Text // JSON: level -> timestamp when first touched
  activeTradeSide     String? // 'YES' or 'NO' - which side ladder is tracking (reset if switching)
  lockedTradeSide     String? // 'YES' or 'NO' - once set, bot will NEVER trade opposite side
  tailActive          Boolean   @default(false)
  stopLossTriggeredAt DateTime? // When pre-game stop loss was triggered (price < 65%)
  cooldownUntil       DateTime? // When re-entry is allowed (stopLoss + 10 min)
  lastProcessed       DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

// Bot configuration stored in DB (source of truth for dashboard)
model BotConfig {
  id            Int      @id @default(1) // Single row
  bankroll      Float    @default(1000) // Initial capital
  lockedProfits Float    @default(0) // Realized profits locked away (never reinvested)
  updatedAt     DateTime @updatedAt
}
